@using Newtonsoft.Json
@using Kanban.Components.DTOs
@using System.Net.Http.Headers

@inject HttpClient http
@inject NavigationManager NavigationManager

@rendermode RenderMode.InteractiveServer

<MudOverlay @bind-Visible="Open" DarkBackground="true" ZIndex="100"><!--Add Column-->
    <MudPaper>
        <MudText>Add a New Column</MudText>
        <MudTextField T="string" @bind-Value="columnTitle" Label="Title" Variant="Variant.Filled" AutoGrow HelperText="Column Title" />
         <MudTextField T="string" @bind-Value="columnOrder" Label="Order" Variant="Variant.Filled" AutoGrow HelperText="Column Order" />
         <MudButtonGroup>
             <MudButton OnClick="(() => CreateColumn())">Submit</MudButton>
             <MudButton OnClick="CloseColumnOverlay">Discard</MudButton>
         </MudButtonGroup>
     </MudPaper>
 </MudOverlay>

@code 
{
    [Parameter]
    public bool Open { get; set; }
    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    [Parameter]
    public List<Guid> Columns { get; set; }
    [Parameter]
    public EventCallback<bool> ColumnsChanged { get; set; }

    [Parameter]
    public List<string> ColumnTitles { get; set; }
    [Parameter]
    public EventCallback<bool> ColumnTitlesChanged { get; set; }

    private string columnTitle = "";
    private string columnOrder = "";
    private async Task<ColumnResponse> CreateColumn ()
    {
        var createRequest = new ColumnCreateRequest
        {
            Title = columnTitle,
            Order = int.Parse (columnOrder),
            BoardID = Guid.Parse ("20a88077-10d4-4648-92cb-7dc7ba5b8df5")
        };

        var httpRequestMessage = new HttpRequestMessage (HttpMethod.Post, @$"{NavigationManager.BaseUri}kanban/createcolumn");
        httpRequestMessage.Content = new StringContent (JsonConvert.SerializeObject (createRequest), mediaType: new MediaTypeHeaderValue (@"application/json"));

        var response = await http.SendAsync (httpRequestMessage);
        if (response.IsSuccessStatusCode)
        {
            var responseBody = await response.Content.ReadAsStringAsync ();
            var deserialized = JsonConvert.DeserializeObject<ColumnResponse> (responseBody);

            Columns.Insert (deserialized.Order, deserialized.ID);
            ColumnTitles.Insert (deserialized.Order, deserialized.Title);

            return deserialized;
        }

        return null;
    }

    private void CloseColumnOverlay ()
    {
        Open = false;
    }
}